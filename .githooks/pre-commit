#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "${ROOT_DIR}"

if ! command -v cargo >/dev/null 2>&1; then
  echo "[fusio pre-commit] skipping: cargo not found" >&2
  exit 0
fi

run_step() {
  local cmd="$1"
  echo "[fusio pre-commit] $cmd"
  if ! eval "$cmd"; then
    echo "[fusio pre-commit] command failed: $cmd" >&2
    if [[ "$cmd" == "$FMT_CHECK_CMD" ]]; then
      echo "[fusio pre-commit] run 'cargo +nightly fmt --all' to apply formatting and re-stage the resulting changes before committing." >&2
    fi
    exit 1
  fi
}

FMT_BIN="cargo +nightly"
if ! command -v rustup >/dev/null 2>&1; then
  echo "[fusio pre-commit] rustup not detected; install rustup and the nightly toolchain" >&2
  exit 1
fi
if ! rustup toolchain list | grep -q "nightly"; then
  echo "[fusio pre-commit] nightly toolchain required (rustup toolchain install nightly)" >&2
  exit 1
fi
FMT_CHECK_CMD="${FMT_BIN} fmt --all -- --check"

# Ensure wasm target is available for the wasm build step.
if ! rustup target list --installed | grep -q "wasm32-unknown-unknown"; then
  run_step "rustup target add wasm32-unknown-unknown"
fi

run_step "${FMT_CHECK_CMD}"
run_step "cargo check --workspace --all-targets"
run_step "cargo check -p fusio-manifest --no-default-features --features std"
run_step "cargo clippy -p fusio-core --all-features -- -D warnings"
run_step "cargo clippy -p fusio --features tokio,aws,tokio-http -- -D warnings"
run_step "cargo clippy -p fusio --features monoio,aws,monoio-http -- -D warnings"
run_step "cargo clippy -p fusio-manifest -- -D warnings"
run_step "cargo clippy -p fusio-manifest --no-default-features --features std -- -D warnings"
run_step "cargo clippy -p fusio-parquet --features tokio -- -D warnings"
run_step "cargo clippy -p fusio-opendal --all-features -- -D warnings"
run_step "cargo clippy -p fusio-object-store --all-features -- -D warnings"
run_step "cargo test -p fusio --features tokio,aws,tokio-http"
run_step "cargo test -p fusio-parquet --features tokio"
run_step "cargo test -p fusio-manifest --lib --no-default-features --features std"
run_step "cargo build --target wasm32-unknown-unknown -p fusio --no-default-features --features \"aws,opfs,web-http\""

exit 0
